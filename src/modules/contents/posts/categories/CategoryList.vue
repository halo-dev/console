<script lang="ts" setup>
// core libs
import { ref } from "vue";
import { apiClient } from "@halo-dev/admin-shared";

// components
import {
  IconAddCircle,
  IconBookRead,
  VButton,
  VCard,
  VPageHeader,
} from "@halo-dev/components";
import CategoryEditingModal from "./components/CategoryEditingModal.vue";
import CategoryListItem from "./components/CategoryListItem.vue";

// types
import type { Category } from "@halo-dev/api-client";
import type { CategoryTree } from "./utils";

// libs
import { useDebounceFn } from "@vueuse/core";
import {
  convertCategoryTreeToCategory,
  convertTreeToCategories,
  resetCategoriesTreePriority,
} from "./utils";

// hooks
import { usePostCategory } from "./composables/use-post-category";

const editingModal = ref(false);
const selectedCategory = ref<Category | null>(null);

const { categories, categoriesTree, handleFetchCategories, handleDelete } =
  usePostCategory();

const handleUpdateInBatch = useDebounceFn(async () => {
  const categoriesTreeToUpdate = resetCategoriesTreePriority(
    categoriesTree.value
  );
  const categoriesToUpdate = convertTreeToCategories(categoriesTreeToUpdate);
  try {
    const promises = categoriesToUpdate.map((category) =>
      apiClient.extension.category.updatecontentHaloRunV1alpha1Category(
        category.metadata.name,
        category
      )
    );
    await Promise.all(promises);
  } catch (e) {
    console.log("Failed to update categories", e);
  } finally {
    await handleFetchCategories();
  }
}, 500);

const handleOpenEditingModal = (category: CategoryTree) => {
  selectedCategory.value = convertCategoryTreeToCategory(category);
  editingModal.value = true;
};

const onEditingModalClose = () => {
  selectedCategory.value = null;
  handleFetchCategories();
};
</script>
<template>
  <CategoryEditingModal
    v-model:visible="editingModal"
    :category="selectedCategory"
    @close="onEditingModalClose"
  />
  <VPageHeader title="文章分类">
    <template #icon>
      <IconBookRead class="mr-2 self-center" />
    </template>

    <template #actions>
      <VButton type="secondary" @click="editingModal = true">
        <template #icon>
          <IconAddCircle class="h-full w-full" />
        </template>
        新建
      </VButton>
    </template>
  </VPageHeader>
  <div class="m-0 md:m-4">
    <VCard :body-class="['!p-0']">
      <template #header>
        <div class="block w-full bg-gray-50 px-4 py-3">
          <div
            class="relative flex flex-col items-start sm:flex-row sm:items-center"
          >
            <div class="flex w-full flex-1 sm:w-auto">
              <span class="text-base font-medium">
                {{ categories.length }} 个分类
              </span>
            </div>
          </div>
        </div>
      </template>
      <CategoryListItem
        :categories="categoriesTree"
        @change="handleUpdateInBatch"
        @delete="handleDelete"
        @open-editing="handleOpenEditingModal"
      />
    </VCard>
  </div>
</template>
